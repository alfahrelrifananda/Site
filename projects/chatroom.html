<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="icon" href="data:image/svg+xml;utf8,
    <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'>
      <rect width='100%' height='100%' fill='%23ffffff'/>
      <text x='50%' y='50%' font-family='Arial, sans-serif' font-weight='700' font-size='36'
            fill='%23000000' dominant-baseline='middle' text-anchor='middle'>AR</text>
    </svg>">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <h1>Chat Room</h1>
    
    <div id="messages">
        <p id="loading">Loading...</p>
    </div>
    
    <hr>
    
    <input type="text" id="messageInput" placeholder="Type your message..." size="50">
    <button onclick="sendMessage()">Send</button>
    
    <hr>
    
    <p>Your ID: <strong id="userId"></strong></p>
    <p id="midnightTimer" style="color: #666; font-size: 0.9em;"></p>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, serverTimestamp, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

	const firebaseConfig = { apiKey: "AIzaSyAx3b277kWrvZv_-luFRdRQ8RuPxM5unu0", authDomain: "chat-room-c01e0.firebaseapp.com", databaseURL: "https://chat-room-c01e0-default-rtdb.europe-west1.firebasedatabase.app", projectId: "chat-room-c01e0", storageBucket: "chat-room-c01e0.firebasestorage.app", messagingSenderId: "424137694744", appId: "1:424137694744:web:47833be9b9ef2af776ad6d" };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const userId = 'User' + Math.floor(Math.random() * 10000);
        document.getElementById('userId').textContent = userId;
        
        const userRef = ref(db, 'presence/' + userId);
        set(userRef, { online: true, timestamp: serverTimestamp() });
        onDisconnect(userRef).remove();
        
        const messagesRef = ref(db, 'messages');
        const presenceRef = ref(db, 'presence');
        
        let firstLoad = true;
        
        onChildAdded(messagesRef, (snapshot) => {
            const msg = snapshot.val();
            
            if (firstLoad) {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.remove();
                firstLoad = false;
            }
            
            displayMessage(msg);
        });
        
        function scheduleNextMidnightClear() {
            const now = new Date();
            const midnight = new Date();
            midnight.setHours(24, 0, 0, 0);
            const msUntilMidnight = midnight - now;
            
            console.log(`Next clear in ${Math.floor(msUntilMidnight / 1000 / 60)} minutes`);
            
            setTimeout(() => {
                remove(messagesRef).then(() => {
                    console.log('Messages cleared at midnight');
                    document.getElementById('messages').innerHTML = '<p style="color: #999;">Messages cleared at midnight</p>';
                }).catch((error) => {
                    console.error('Error clearing messages:', error);
                });
                
                remove(presenceRef).then(() => {
                    console.log('Presence cleared at midnight');
                }).catch((error) => {
                    console.error('Error clearing presence:', error);
                });
                
                scheduleNextMidnightClear();
            }, msUntilMidnight);
            
            updateTimerDisplay();
        }
        
        function updateTimerDisplay() {
            setInterval(() => {
                const now = new Date();
                const midnight = new Date();
                midnight.setHours(24, 0, 0, 0);
                
                const msUntilMidnight = midnight - now;
                const hours = Math.floor(msUntilMidnight / 1000 / 60 / 60);
                const minutes = Math.floor((msUntilMidnight / 1000 / 60) % 60);
                const seconds = Math.floor((msUntilMidnight / 1000) % 60);
                
                document.getElementById('midnightTimer').textContent = 
                    `Messages clear at midnight in: ${hours}h ${minutes}m ${seconds}s`;
            }, 1000);
        }
        
        // Start midnight clear scheduler
        scheduleNextMidnightClear();
        
        window.sendMessage = function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (text === '') return;
            
            push(messagesRef, {
                user: userId,
                text: text,
                timestamp: serverTimestamp()
            });
            
            input.value = '';
        };
        
        function displayMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            
            const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : 'now';
            msgDiv.innerHTML = `<strong>${msg.user}</strong> [${time}]: ${escapeHtml(msg.text)}`;
            
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
