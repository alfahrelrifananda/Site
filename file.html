<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File Transfer App</title>
  </head>
  <body>
    <div>
      <h1>File Transfer</h1>
      <p>Share files using firebase :(</p>

      <div id="uploadArea">
        <h3>Drop your file here or click to browse</h3>
        <p>Maximum file size: 33MB</p>
        <input type="file" id="fileInput" accept="*/*" />
      </div>

      <div id="fileInfo" style="display: none">
        <div id="fileName"></div>
        <div id="fileMeta"></div>
      </div>

      <div id="progressBar" style="display: none">
        <div id="progressFill"></div>
      </div>

      <div>
        <button id="uploadBtn" disabled>Upload File</button>
      </div>

      <div id="shareCode" style="display: none">
        <strong>Share this code:</strong>
        <div id="codeDisplay"></div>
        <p>Give this code to anyone who needs to download your file</p>
      </div>

      <div id="errorMsg" style="display: none"></div>
      <div id="successMsg" style="display: none"></div>

      <hr />

      <div id="fileList">
        <h3>All Uploaded Files</h3>
        <div id="fileListContainer"></div>
      </div>

      <hr />
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        push,
        remove,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDS9LeHsdoYN4uVb1JVwuIpM7uRN1x_NDI",
        authDomain: "file-transfer-9cfc6.firebaseapp.com",
        databaseURL: "https://file-transfer-9cfc6-default-rtdb.firebaseio.com",
        projectId: "file-transfer-9cfc6",
        storageBucket: "file-transfer-9cfc6.firebasestorage.app",
        messagingSenderId: "637877912480",
        appId: "1:637877912480:web:4fd61c07ca4c906a229ac5",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let selectedFile = null;
      const MAX_FILE_SIZE = 33 * 1024 * 1024; // 33MB

      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const fileName = document.getElementById("fileName");
      const fileMeta = document.getElementById("fileMeta");
      const uploadBtn = document.getElementById("uploadBtn");
      const shareCode = document.getElementById("shareCode");
      const codeDisplay = document.getElementById("codeDisplay");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const errorMsg = document.getElementById("errorMsg");
      const successMsg = document.getElementById("successMsg");
      const fileListContainer = document.getElementById("fileListContainer");

      uploadArea.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });

      function handleFileSelect(file) {
        hideMessages();

        if (file.size > MAX_FILE_SIZE) {
          showError("File is too large. Maximum size is 33MB.");
          return;
        }

        selectedFile = file;
        fileName.textContent = file.name;
        fileMeta.textContent = `${(file.size / 1024).toFixed(2)} KB - ${file.type || "Unknown type"}`;
        fileInfo.style.display = "block";
        uploadBtn.disabled = false;
        shareCode.style.display = "none";
      }

      uploadBtn.addEventListener("click", async () => {
        if (!selectedFile) return;

        uploadBtn.disabled = true;
        progressBar.style.display = "block";
        hideMessages();

        try {
          const base64 = await fileToBase64(selectedFile);

          const filesRef = ref(db, "files");
          const newFileRef = push(filesRef);

          await set(newFileRef, {
            name: selectedFile.name,
            type: selectedFile.type,
            size: selectedFile.size,
            data: base64,
            timestamp: Date.now(),
          });

          progressFill.textContent = "Upload complete!";

          showSuccess("File uploaded successfully!");

          setTimeout(() => {
            resetUpload();
          }, 1000);
        } catch (error) {
          showError("Upload failed: " + error.message);
          uploadBtn.disabled = false;
        }
      });

      retrieveBtn.addEventListener("click", async () => {
        const code = retrieveCode.value.trim().toUpperCase();

        if (!code) {
          showError("Please enter a file code");
          return;
        }

        retrieveBtn.disabled = true;
        hideMessages();

        try {
          const fileRef = ref(db, `files/${code}`);
          const snapshot = await get(fileRef);

          if (snapshot.exists()) {
            const fileData = snapshot.val();

            const blob = base64ToBlob(fileData.data, fileData.type);
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileData.name;
            a.click();
            URL.revokeObjectURL(url);

            showSuccess("File downloaded successfully!");
            retrieveCode.value = "";
          } else {
            showError("File not found. Please check the code.");
          }
        } catch (error) {
          showError("Download failed: " + error.message);
        } finally {
          retrieveBtn.disabled = false;
        }
      });

      function loadRecentFiles() {
        const filesRef = ref(db, "files");
        onValue(filesRef, (snapshot) => {
          fileListContainer.innerHTML = "";
          const files = [];

          snapshot.forEach((childSnapshot) => {
            files.push({
              code: childSnapshot.key,
              ...childSnapshot.val(),
            });
          });

          files.sort((a, b) => b.timestamp - a.timestamp);

          files.forEach((file) => {
            const fileItem = createFileItem(file);
            fileListContainer.appendChild(fileItem);
          });
        });
      }

      function createFileItem(file) {
        const div = document.createElement("div");

        const date = new Date(file.timestamp).toLocaleString();

        div.innerHTML = `
                <div>
                    <div><strong>${file.name}</strong></div>
                    <div>${(file.size / 1024).toFixed(2)} KB - ${date}</div>
                    <button onclick="downloadFile('${file.code}')">Download</button>
                    <button onclick="deleteFile('${file.code}')">Delete</button>
                </div>
                <br>
            `;

        return div;
      }

      window.downloadFile = async (code) => {
        try {
          const fileRef = ref(db, `files/${code}`);
          const snapshot = await get(fileRef);

          if (snapshot.exists()) {
            const fileData = snapshot.val();
            const blob = base64ToBlob(fileData.data, fileData.type);
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileData.name;
            a.click();
            URL.revokeObjectURL(url);
            showSuccess("File downloaded!");
          }
        } catch (error) {
          showError("Download failed");
        }
      };

      window.deleteFile = async (code) => {
        if (!confirm("Are you sure you want to delete this file?")) return;

        try {
          const fileRef = ref(db, `files/${code}`);
          await remove(fileRef);
          showSuccess("File deleted successfully");
        } catch (error) {
          showError("Delete failed");
        }
      };

       function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function base64ToBlob(base64, type) {
            const parts = base64.split(';base64,');
            const contentType = type || parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);

            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }

            return new Blob([uInt8Array], { type: contentType });
        }

      function resetUpload() {
        selectedFile = null;
        fileInput.value = "";
        fileInfo.style.display = "none";
        progressBar.style.display = "none";
        progressFill.textContent = "";
        uploadBtn.disabled = true;
      }

      function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = "block";
      }

      function showSuccess(message) {
        successMsg.textContent = message;
        successMsg.style.display = "block";
      }

      function hideMessages() {
        errorMsg.style.display = "none";
        successMsg.style.display = "none";
      }

      loadRecentFiles();
    </script>
  </body>
</html>
